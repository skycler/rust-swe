name: C++ CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'cpp/**'
      - '.github/workflows/cpp-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'cpp/**'

jobs:
  lint:
    name: Lint (clang-format & clang-tidy)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cpp

    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format and clang-tidy
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format clang-tidy

      - name: Check formatting
        run: |
          find src include tests examples -name '*.cpp' -o -name '*.hpp' | \
          xargs clang-format --dry-run --Werror

  build-and-test:
    name: Build & Test (${{ matrix.os }}, ${{ matrix.build_type }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        build_type: [Debug, Release]

    defaults:
      run:
        working-directory: cpp

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ libomp-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake libomp

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DENABLE_OPENMP=ON \
            -DBUILD_TESTS=ON \
            -DBUILD_EXAMPLES=ON

      - name: Build
        run: cmake --build build --config ${{ matrix.build_type }} -j$(nproc)

      - name: Run Tests
        run: |
          cd build
          ctest --output-on-failure --build-config ${{ matrix.build_type }}

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.build_type }}
          path: cpp/build/Testing/

  windows-build:
    name: Build & Test (Windows, MSVC)
    runs-on: windows-latest
    defaults:
      run:
        working-directory: cpp

    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Configure CMake
        run: |
          cmake -B build `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_TESTS=ON `
            -DBUILD_EXAMPLES=ON

      - name: Build
        run: cmake --build build --config Release

      - name: Run Tests
        run: |
          cd build
          ctest --output-on-failure --build-config Release

  benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cpp

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ libomp-dev time

      - name: Build Release
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_OPENMP=ON
          cmake --build build --config Release -j$(nproc)

      - name: Run benchmark
        run: |
          echo "=== 50x50 Mesh ===" >> benchmark_results.txt
          /usr/bin/time -v ./build/bin/shallow-water-solver \
            --nx 50 --ny 50 -t 1.0 2>&1 | tee -a benchmark_results.txt
          
          echo "=== 100x100 Mesh ===" >> benchmark_results.txt
          /usr/bin/time -v ./build/bin/shallow-water-solver \
            --nx 100 --ny 100 -t 1.0 2>&1 | tee -a benchmark_results.txt

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: cpp/benchmark_results.txt

  publish-artifacts:
    name: Publish Build Artifacts
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    defaults:
      run:
        working-directory: cpp

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ libomp-dev

      - name: Build Release
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_OPENMP=ON
          cmake --build build --config Release -j$(nproc)

      - name: Create tarball
        run: |
          mkdir -p artifacts
          tar -czf artifacts/shallow-water-solver-linux-x64.tar.gz \
            -C build/bin shallow-water-solver dam_break radial_dam tsunami

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cpp-binaries-linux
          path: cpp/artifacts/*.tar.gz
